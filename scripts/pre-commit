#!/usr/bin/env bash
#
# Git pre-commit hook for pgn-extract-go
# This script runs formatting, linting, and tests before each commit.
#
# Installation:
#   Option 1 (symlink): ln -sf ../../scripts/pre-commit .git/hooks/pre-commit
#   Option 2 (copy): cp scripts/pre-commit .git/hooks/pre-commit && chmod +x .git/hooks/pre-commit
#   Option 3 (pre-commit framework): pip install pre-commit && pre-commit install
#
# To skip this hook temporarily: git commit --no-verify

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
info() { echo -e "${BLUE}[INFO]${NC} $*"; }
success() { echo -e "${GREEN}[PASS]${NC} $*"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
error() { echo -e "${RED}[FAIL]${NC} $*"; }

# Track overall status
FAILED=0

# Protected branches - commits directly to these are blocked
PROTECTED_BRANCHES=("main" "master")

# =============================================================================
# Check 0: Branch protection
# =============================================================================
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "")

for PROTECTED in "${PROTECTED_BRANCHES[@]}"; do
    if [ "$CURRENT_BRANCH" = "$PROTECTED" ]; then
        echo ""
        echo "=========================================="
        error "Direct commits to '$PROTECTED' branch are not allowed!"
        echo "=========================================="
        echo ""
        echo "Please create a feature branch and submit a pull request:"
        echo ""
        echo "  git checkout -b feature/your-feature-name"
        echo "  git commit -m 'Your commit message'"
        echo "  git push -u origin feature/your-feature-name"
        echo ""
        echo "Then create a Pull Request on GitHub."
        echo ""
        echo "If you absolutely must commit directly (not recommended):"
        echo "  git commit --no-verify"
        echo ""
        exit 1
    fi
done

# Get list of staged Go files
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    info "No Go files staged for commit"
    exit 0
fi

echo ""
echo "=========================================="
echo "  Pre-commit checks for pgn-extract-go"
echo "=========================================="
echo ""

# =============================================================================
# Check 1: go fmt
# =============================================================================
info "Running go fmt..."

UNFMT_FILES=$(gofmt -l $STAGED_GO_FILES 2>&1 || true)
if [ -n "$UNFMT_FILES" ]; then
    error "The following files need formatting:"
    echo "$UNFMT_FILES" | sed 's/^/  /'
    echo ""
    echo "Run: gofmt -w \$(git diff --cached --name-only | grep '\\.go\$')"
    FAILED=1
else
    success "go fmt passed"
fi

# =============================================================================
# Check 2: go vet
# =============================================================================
info "Running go vet..."

if ! GO111MODULE=on go vet ./... 2>&1; then
    error "go vet failed"
    FAILED=1
else
    success "go vet passed"
fi

# =============================================================================
# Check 3: staticcheck (if available)
# =============================================================================
if command -v staticcheck &> /dev/null; then
    info "Running staticcheck..."
    if ! GO111MODULE=on staticcheck ./... 2>&1; then
        error "staticcheck failed"
        FAILED=1
    else
        success "staticcheck passed"
    fi
else
    warn "staticcheck not installed (install: go install honnef.co/go/tools/cmd/staticcheck@latest)"
fi

# =============================================================================
# Check 4: golangci-lint (if available)
# =============================================================================
if command -v golangci-lint &> /dev/null; then
    info "Running golangci-lint..."
    if ! golangci-lint run --timeout=5m ./... 2>&1; then
        error "golangci-lint failed"
        FAILED=1
    else
        success "golangci-lint passed"
    fi
else
    warn "golangci-lint not installed (see: https://golangci-lint.run/usage/install/)"
fi

# =============================================================================
# Check 5: Build verification
# =============================================================================
info "Verifying build..."

if ! GO111MODULE=on go build -o /dev/null ./cmd/pgn-extract/ 2>&1; then
    error "Build failed"
    FAILED=1
else
    success "Build passed"
fi

# =============================================================================
# Check 6: Quick tests (no race detector for speed)
# =============================================================================
info "Running quick tests..."

if ! GO111MODULE=on go test -short ./... 2>&1; then
    error "Tests failed"
    FAILED=1
else
    success "Tests passed"
fi

# =============================================================================
# Check 7: go mod tidy verification
# =============================================================================
info "Checking go.mod tidiness..."

# Save current state
cp go.mod go.mod.bak
if [ -f go.sum ]; then
    cp go.sum go.sum.bak
fi

# Run tidy
GO111MODULE=on go mod tidy 2>/dev/null

# Check for differences
if ! diff -q go.mod go.mod.bak > /dev/null 2>&1; then
    error "go.mod is not tidy. Run: go mod tidy"
    mv go.mod.bak go.mod
    if [ -f go.sum.bak ]; then
        mv go.sum.bak go.sum
    fi
    FAILED=1
else
    rm go.mod.bak
    if [ -f go.sum.bak ]; then
        rm go.sum.bak
    fi
    success "go.mod is tidy"
fi

# =============================================================================
# Summary
# =============================================================================
echo ""
echo "=========================================="

if [ $FAILED -ne 0 ]; then
    error "Pre-commit checks FAILED"
    echo ""
    echo "Fix the issues above and try again."
    echo "To skip these checks (not recommended): git commit --no-verify"
    exit 1
else
    success "All pre-commit checks passed!"
    echo "=========================================="
    exit 0
fi
